from aiogram import Router, F
from aiogram.filters import CommandStart
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
import logging

from src.bot.services.menu_constructor import build_user_inline_keyboard
from src.bot.database.start_message import get_start_message
from src.bot.config import get_config

logger = logging.getLogger(__name__)

start_router = Router(name="start")


class FeedbackStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏."""
    waiting_for_feedback_message = State()  # –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è


def _is_admin(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º."""
    config = get_config()
    return user_id in config.admin_ids


@start_router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext) -> None:
    user_id = message.from_user.id
    is_admin_user = _is_admin(user_id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–µ–π—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    data = await state.get_data()
    current_admin_mode = data.get("admin_mode", False)
    current_user_mode = data.get("user_mode", False)
    
    logger.info(
        f"[START] user_id={user_id}, is_admin={is_admin_user}, "
        f"current_state: admin_mode={current_admin_mode}, user_mode={current_user_mode}"
    )
    
    # –ü—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start –í–°–ï–ì–î–ê —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –ê–¥–º–∏–Ω—Å–∫–æ–µ –º–µ–Ω—é –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /admin
    await state.update_data(user_mode=True, admin_mode=False)
    logger.info(f"[START] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è user_id={user_id} (is_admin={is_admin_user})")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–µ–π—Ç –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    data_after = await state.get_data()
    logger.info(
        f"[START] –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–µ–π—Ç–∞: admin_mode={data_after.get('admin_mode', False)}, "
        f"user_mode={data_after.get('user_mode', False)}"
    )
    
    kb = await build_user_inline_keyboard()
    start_text = await get_start_message()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ message_id –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    sent_message = await message.answer(start_text, reply_markup=kb)
    await state.update_data(main_menu_message_id=sent_message.message_id)


@start_router.message(FeedbackStates.waiting_for_feedback_message, F.text)
async def process_feedback(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = message.from_user.id
    feedback_text = message.text
    
    logger.info(f"[FEEDBACK] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {feedback_text}")
    
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å feedback –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞–º
    # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ
    config = get_config()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    back_button = InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text="<- –ù–∞–∑–∞–¥", callback_data="back_to_menu")]]
    )
    
    await message.answer(
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à—É –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ—ë —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º.",
        reply_markup=back_button
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º feedback –∞–¥–º–∏–Ω–∞–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if config.admin_ids:
        feedback_message = (
            f"üì© –ù–æ–≤–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n"
            f"ID: {user_id}\n"
            f"Username: @{message.from_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
            f"–ò–º—è: {message.from_user.first_name or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n\n"
            f"–°–æ–æ–±—â–µ–Ω–∏–µ:\n{feedback_text}"
        )
        
        for admin_id in config.admin_ids:
            try:
                await message.bot.send_message(chat_id=admin_id, text=feedback_message)
            except Exception as e:
                logger.error(f"[FEEDBACK] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å feedback –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

